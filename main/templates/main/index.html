{% extends 'base.html' %}
{% load humanize %}

{% block title %}Trang chủ - YouTube Trending Analytics{% endblock %}

{% block content %}
<section class="mb-10">
    <div class="flex items-end justify-between gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Bảng điều khiển xu hướng YouTube</h1>
            <p class="text-slate-400 mt-2">Phân tích dữ liệu trending từ tập dữ liệu nội bộ (CSV) với biểu đồ tương tác.</p>
        </div>
        <div class="flex items-center gap-3">
            <button id="refreshBtn" class="inline-flex items-center gap-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm transition">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M5.635 5.636a9 9 0 1112.728 12.728A9 9 0 015.635 5.636zm11.314 1.414a7 7 0 10-9.9 9.9 7 7 0 009.9-9.9z" clip-rule="evenodd" />
                </svg>
                Làm mới dữ liệu
            </button>
        </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6" id="statCards">
        <div class="rounded-2xl bg-gradient-to-br from-fuchsia-600/20 to-indigo-600/20 border border-white/10 p-5">
            <div class="text-sm text-slate-300">Tổng Views</div>
            <div class="mt-2 text-2xl font-bold" id="totalViews">—</div>
            <div class="mt-1 text-xs text-slate-400">từ toàn bộ video</div>
        </div>
        <div class="rounded-2xl bg-gradient-to-br from-emerald-600/20 to-teal-600/20 border border-white/10 p-5">
            <div class="text-sm text-slate-300">Tổng Likes</div>
            <div class="mt-2 text-2xl font-bold" id="totalLikes">—</div>
            <div class="mt-1 text-xs text-slate-400">chỉ số tương tác</div>
        </div>
        <div class="rounded-2xl bg-gradient-to-br from-cyan-600/20 to-sky-600/20 border border-white/10 p-5">
            <div class="text-sm text-slate-300">Tổng Comments</div>
            <div class="mt-2 text-2xl font-bold" id="totalComments">—</div>
            <div class="mt-1 text-xs text-slate-400">thảo luận của người xem</div>
        </div>
        <div class="rounded-2xl bg-gradient-to-br from-amber-600/20 to-rose-600/20 border border-white/10 p-5">
            <div class="text-sm text-slate-300">Số Video</div>
            <div class="mt-2 text-2xl font-bold" id="totalVideos">—</div>
            <div class="mt-1 text-xs text-slate-400">bản ghi trong CSV</div>
        </div>
    </div>
</section>

<section class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <div class="xl:col-span-2 space-y-6">
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Top danh mục</h2>
                <span class="text-xs text-slate-400">Biểu đồ cột</span>
            </div>
            <div id="barCategories" class="h-[360px] mt-2"></div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Top video theo Views</h2>
                <span class="text-xs text-slate-400">Cột nhóm</span>
            </div>
            <div id="barTopVideos" class="h-[420px] mt-2"></div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Likes & Comments theo dải Views</h2>
                <span class="text-xs text-slate-400">Stacked Bar</span>
            </div>
            <div id="barEngagementBin" class="h-[360px] mt-2"></div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Tỷ trọng danh mục</h2>
                <span class="text-xs text-slate-400">Biểu đồ tròn</span>
            </div>
            <div id="pieCategories" class="h-[360px] mt-2"></div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Phân tán Like-View-Comment</h2>
                <span class="text-xs text-slate-400">Scatter 3D 2D</span>
            </div>
            <div id="scatterEngagement" class="h-[360px] mt-2"></div>
        </div>
        <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur p-4">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Từ khóa nổi bật</h2>
                <span class="text-xs text-slate-400">Word Cloud</span>
            </div>
            <div id="wordCloud" class="h-[360px] mt-2"></div>
        </div>
    </div>
</section>

<section class="mt-6">
    <div class="rounded-2xl border border-white/10 bg-gradient-to-r from-slate-900/60 to-slate-800/60 p-6">
        <div class="flex items-center justify-between gap-4 flex-wrap">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-fuchsia-600 to-indigo-600 animate-pulse"></div>
                <div>
                    <div class="font-semibold">Nguồn dữ liệu</div>
                    <div class="text-xs text-slate-400">Đọc từ file CSV: data/data_youtube_trending_video.csv</div>
                </div>
            </div>
            <a href="/du-lieu/" class="inline-flex items-center gap-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 text-sm transition">Xem chi tiết dữ liệu</a>
        </div>
    </div>
    <div id="errorBox" class="hidden mt-4 rounded-xl border border-rose-500/30 bg-rose-500/10 text-rose-200 p-4 text-sm"></div>
    <div id="loadingBar" class="mt-4 h-1 w-full overflow-hidden rounded bg-white/10">
        <div class="h-1 w-1/3 loading-slide bg-gradient-to-r from-fuchsia-500 to-indigo-500"></div>
    </div>
</section>
{% endblock %}

{% block body_extra %}
<script>
// Animation keyframes for loading bar
const style = document.createElement('style');
style.textContent = `
@keyframes load {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(50%); }
  100% { transform: translateX(200%); }
}
.loading-slide { animation: load 1.6s ease-in-out infinite; }
`;
document.head.appendChild(style);

const fmt = (n) => new Intl.NumberFormat('vi-VN').format(n || 0);

const charts = {
    barCategories: null,
    pieCategories: null,
    scatterEngagement: null,
    barTopVideos: null,
    barEngagementBin: null,
    wordCloud: null,
};

function initCharts() {
    charts.barCategories = echarts.init(document.getElementById('barCategories'));
    charts.pieCategories = echarts.init(document.getElementById('pieCategories'));
    charts.scatterEngagement = echarts.init(document.getElementById('scatterEngagement'));
    charts.barTopVideos = echarts.init(document.getElementById('barTopVideos'));
    charts.barEngagementBin = echarts.init(document.getElementById('barEngagementBin'));
    charts.wordCloud = echarts.init(document.getElementById('wordCloud'));
}

function setStats(totals){
    document.getElementById('totalViews').textContent = fmt(totals.views);
    document.getElementById('totalLikes').textContent = fmt(totals.likes);
    document.getElementById('totalComments').textContent = fmt(totals.comments);
    document.getElementById('totalVideos').textContent = fmt(totals.videos);
}

function renderCharts(data) {
    const colors = ['#a855f7','#6366f1','#22d3ee','#06b6d4','#f59e0b','#ef4444','#10b981'];

    // Bar Categories
    const catNames = data.categories.map(c=>c.name);
    const catValues = data.categories.map(c=>c.value);
    charts.barCategories.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        grid: { left: 40, right: 20, top: 30, bottom: 40 },
        xAxis: { type: 'category', data: catNames, axisLabel: { color: '#cbd5e1', rotate: 30 } },
        yAxis: { type: 'value', axisLabel: { color: '#cbd5e1' }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.06)' } } },
        series: [{
            type: 'bar',
            data: catValues,
            itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#a855f7'},{offset:1,color:'#6366f1'}]) },
            showBackground: true,
            backgroundStyle: { color: 'rgba(255,255,255,0.03)' },
            animationDuration: 1200,
        }]
    });

    // Pie Categories
    charts.pieCategories.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        series: [{
            type: 'pie',
            radius: ['35%','70%'],
            roseType: 'area',
            itemStyle: { borderRadius: 8 },
            label: { color: '#e2e8f0' },
            data: data.categories.map((c, i)=> ({ value: c.value, name: c.name, itemStyle:{ color: colors[i%colors.length] } })),
            animationEasing: 'elasticOut',
            animationDelay: (idx)=> idx*30
        }]
    });

    // Scatter Engagement
    charts.scatterEngagement.setOption({
        backgroundColor: 'transparent',
        tooltip: { formatter: (p)=>`Views: ${fmt(p.data[0])}<br/>Likes: ${fmt(p.data[1])}<br/>Comments: ${fmt(p.data[2])}` },
        xAxis: { type: 'log', name: 'Views', axisLabel:{ color:'#cbd5e1' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,0.06)'} } },
        yAxis: { type: 'log', name: 'Likes', axisLabel:{ color:'#cbd5e1' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,0.06)'} } },
        series: [{
            type: 'scatter',
            symbolSize: (d)=> Math.max(4, Math.log(d[2]+2)),
            data: data.scatter,
            itemStyle: { color: '#22d3ee' },
            emphasis: { itemStyle:{ color:'#06b6d4' } },
            animationDuration: 1000
        }]
    });

    // Top Videos bar
    charts.barTopVideos.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data: ['Views','Likes','Comments'], textStyle:{ color:'#cbd5e1' } },
        grid: { left: 140, right: 20, top: 30, bottom: 20 },
        xAxis: { type: 'value', axisLabel:{ color:'#cbd5e1' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,0.06)' } } },
        yAxis: { type: 'category', data: data.topVideos.titles, axisLabel:{ color:'#cbd5e1' } },
        series: [
            { name:'Views', type:'bar', data: data.topVideos.views, itemStyle:{ color:'#a855f7' } },
            { name:'Likes', type:'bar', data: data.topVideos.likes, itemStyle:{ color:'#22d3ee' } },
            { name:'Comments', type:'bar', data: data.topVideos.comments, itemStyle:{ color:'#f59e0b' } },
        ]
    });

    // Engagement by bins (stacked)
    charts.barEngagementBin.setOption({
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data:['Avg Likes','Avg Comments','Số video'], textStyle:{ color:'#cbd5e1' } },
        grid: { left: 40, right: 20, top: 30, bottom: 40 },
        xAxis: { type: 'category', data: data.engagementByBin.bins, axisLabel:{ color:'#cbd5e1' } },
        yAxis: { type: 'value', axisLabel:{ color:'#cbd5e1' }, splitLine:{ lineStyle:{ color:'rgba(255,255,255,0.06)' } } },
        series: [
            { name:'Avg Likes', type:'bar', stack:'a', data: data.engagementByBin.avgLikes, itemStyle:{ color:'#22d3ee' } },
            { name:'Avg Comments', type:'bar', stack:'a', data: data.engagementByBin.avgComments, itemStyle:{ color:'#06b6d4' } },
            { name:'Số video', type:'line', data: data.engagementByBin.counts, itemStyle:{ color:'#f59e0b' } }
        ]
    });

    // Word cloud
    charts.wordCloud.setOption({
        backgroundColor: 'transparent',
        series: [{
            type: 'wordCloud',
            gridSize: 8,
            sizeRange: [12, 42],
            rotationRange: [-45, 0, 45, 90],
            shape: 'circle',
            textStyle: {
                color: ()=> colors[Math.floor(Math.random()*colors.length)]
            },
            data: data.wordCloud
        }]
    });
}

async function loadData() {
    const errorBox = document.getElementById('errorBox');
    const loadingBar = document.getElementById('loadingBar');
    errorBox.classList.add('hidden');
    loadingBar.classList.remove('hidden');
    try {
        const res = await fetch('/api/dashboard-csv/');
        if (!res.ok) throw new Error('Không thể tải dữ liệu CSV');
        const data = await res.json();
        setStats(data.totals);
        renderCharts(data);
    } catch (e) {
        errorBox.textContent = e.message;
        errorBox.classList.remove('hidden');
    } finally {
        loadingBar.classList.add('hidden');
        Object.values(charts).forEach(c=> c && c.resize());
    }
}

window.addEventListener('resize', ()=> {
    Object.values(charts).forEach(c=> c && c.resize());
});

document.getElementById('refreshBtn')?.addEventListener('click', loadData);

initCharts();
loadData();
</script>
{% endblock %}


